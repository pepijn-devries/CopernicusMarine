<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using stars_proxy Objects • CopernicusMarine</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using stars_proxy Objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CopernicusMarine</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.2.0001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/proxy.html">Using stars_proxy Objects</a></li>
    <li><a class="dropdown-item" href="../articles/translate.html">Translate Request</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pepijn-devries/CopernicusMarine/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Using stars_proxy Objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pepijn-devries/CopernicusMarine/blob/master/vignettes/proxy.Rmd" class="external-link"><code>vignettes/proxy.Rmd</code></a></small>
      <div class="d-none name"><code>proxy.Rmd</code></div>
    </div>

    
    
<p>Using <a href="https://r-spatial.github.io/stars/articles/stars2.html#stars-proxy-objects" class="external-link"><code>stars_proxy</code>
objects</a> in combination with the CopernicusMarine package introduces
opportunities to efficiently work with Data from Copernicus Marine
services on the fly.</p>
<p>The great thing about these proxy objects is that they will not read
any data unless it is needed. So, you can connect to a dataset from the
Copernicus server without having to read raster data. Instead it will
only collect meta data about the raster’s dimensions and bands
(attributes). The actual raster data is only downloaded when you need
it.</p>
<div class="section level2">
<h2 id="setting-up-a-proxy-object">Setting Up a Proxy Object<a class="anchor" aria-label="anchor" href="#setting-up-a-proxy-object"></a>
</h2>
<p>You can either set up a proxy object by calling
<code><a href="../reference/cms_native_proxy.html">cms_native_proxy()</a></code> or <code>cms_zarr_prox()</code>. The
first uses the ‘native’ service. In this case the data is already
structured in chunked files and the added value of proxy objects is not
that obvious. Therefore, in this vignette, we will focus on objects
created with <code><a href="../reference/cms_zarr_proxy.html">cms_zarr_proxy()</a></code>. It will connect with an
entire layer in a product.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pepijn-devries/CopernicusMarine" class="external-link">CopernicusMarine</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span></span>
<span><span class="va">my_proxy_gc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cms_zarr_proxy.html">cms_zarr_proxy</a></span><span class="op">(</span></span>
<span>  product       <span class="op">=</span> <span class="st">"GLOBAL_ANALYSISFORECAST_PHY_001_024"</span>,</span>
<span>  layer         <span class="op">=</span> <span class="st">"cmems_mod_glo_phy-thetao_anfc_0.083deg_P1D-m"</span>,</span>
<span>  asset         <span class="op">=</span> <span class="st">"geoChunked"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_proxy_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cms_zarr_proxy.html">cms_zarr_proxy</a></span><span class="op">(</span></span>
<span>  product       <span class="op">=</span> <span class="st">"GLOBAL_ANALYSISFORECAST_PHY_001_024"</span>,</span>
<span>  layer         <span class="op">=</span> <span class="st">"cmems_mod_glo_phy-thetao_anfc_0.083deg_P1D-m"</span>,</span>
<span>  asset         <span class="op">=</span> <span class="st">"timeChunked"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">my_proxy_tc</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars_proxy object with 1 attribute in 1 file(s):</span></span>
<span><span class="co">#&gt; $thetao</span></span>
<span><span class="co">#&gt; [1] "[...]/timeChunked.zarr"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;           from   to     offset  delta  refsys</span></span>
<span><span class="co">#&gt; longitude    1 4320         NA     NA      NA</span></span>
<span><span class="co">#&gt; latitude     1 2041         NA     NA      NA</span></span>
<span><span class="co">#&gt; elevation    1   50         NA     NA udunits</span></span>
<span><span class="co">#&gt; time         1 1367 2022-06-01 1 days    Date</span></span>
<span><span class="co">#&gt;                                                            values x/y</span></span>
<span><span class="co">#&gt; longitude            [-180.0417,-179.9583),...,[179.875,179.9584) [x]</span></span>
<span><span class="co">#&gt; latitude            [-80.04167,-79.95833),...,[89.95834,90.04166) [y]</span></span>
<span><span class="co">#&gt; elevation [-5727.917,-5274.784) [m],...,[-0.494025,0.5533251) [m]    </span></span>
<span><span class="co">#&gt; time                                                         NULL</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="selecting-an-asset-type">Selecting an Asset Type<a class="anchor" aria-label="anchor" href="#selecting-an-asset-type"></a>
</h2>
<p>The only downside from working with proxy objects is that you need to
know which asset type you wish to use. When subsetting data with
<code><a href="../reference/cms_download_subset.html">cms_download_subset()</a></code> this selection is automated based on
your selection criteria. But when working with a proxy object, you may
not know which slices you wish to select in advance.</p>
<p>In general, if you wish to work with long time-series in a small
geographical area, it’s most efficient to work with
<code>"geoChunked"</code> data. Whereas, if you want to work with a
short time period, but on a large geographical scale, it is better to
use <code>"timeChunked"</code> data.</p>
</div>
<div class="section level2">
<h2 id="slicing-a-proxy-object">Slicing a Proxy Object<a class="anchor" aria-label="anchor" href="#slicing-a-proxy-object"></a>
</h2>
<p>As you can see from the proxy object printed above, it has dimension
that stretch pretty far. It has daily data for nearly four years, in 50
depth layers with global coverage. If you would try to read this raster
data, it will almost certainly fail as it would require thousands of Gb
of memory which is simply not available on most devices.</p>
<p>Fortunately, the proxy object can easily be sliced, by selecting
index values with the bracket operator (<code>[</code>). The first index
represents the band (attribute), and we skip it, next are the
<code>x</code> and <code>y</code> coordinate, followed by the elevation.
The last dimension is time, were we select the first four hundred
records.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_slice</span> <span class="op">&lt;-</span> <span class="va">my_proxy_gc</span><span class="op">[</span>,<span class="fl">2000</span>, <span class="fl">1000</span>, <span class="fl">48</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">400</span><span class="op">]</span></span>
<span><span class="fu">show</span><span class="op">(</span><span class="va">time_slice</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars_proxy object with 1 attribute in 1 file(s):</span></span>
<span><span class="co">#&gt; $thetao</span></span>
<span><span class="co">#&gt; [1] "[...]/geoChunked.zarr"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;           from   to     offset  delta  refsys              values x/y</span></span>
<span><span class="co">#&gt; longitude 2000 2000         NA     NA      NA     [-13.46,-13.37) [x]</span></span>
<span><span class="co">#&gt; latitude  1000 1000         NA     NA      NA       [3.208,3.292) [y]</span></span>
<span><span class="co">#&gt; elevation   48   48         NA     NA udunits [-2.646,-1.541) [m]    </span></span>
<span><span class="co">#&gt; time         1  400 2022-06-01 1 days    Date                NULL</span></span></code></pre></div>
<p>As you can notice, this slicing is super fast. This is because no
actual data is transfered yet. It isn’t until <code><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars()</a></code>
is called when the data is downloaded. Since in this particular case we
have only selected a single raster cell, it makes sense to cast the
object to a <code>data.frame</code>. We can then plot the time
series.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_slice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span><span class="va">time_slice</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="va">time_slice</span>, <span class="st">"time"</span><span class="op">)</span>, <span class="va">time_slice</span><span class="op">$</span><span class="va">thetao</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"date"</span>, ylab <span class="op">=</span> <span class="st">"temperature"</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="proxy_files/figure-html/plot_time_slice-1.png" class="r-plt" alt="" width="700"></p>
<p>We can also select a specific area, for which we will use the time
chunked proxy.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_slice</span> <span class="op">&lt;-</span> <span class="va">my_proxy_tc</span><span class="op">[</span>,<span class="fl">2000</span><span class="op">:</span><span class="fl">2500</span>, <span class="fl">1500</span><span class="op">:</span><span class="fl">1750</span>, <span class="fl">50</span>, <span class="fl">500</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">geo_slice</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="proxy_files/figure-html/slice_area-1.png" class="r-plt" alt="" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pepijn de Vries.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
